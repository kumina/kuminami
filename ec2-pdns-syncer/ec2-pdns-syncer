#!/bin/sh

set -e

if test $# -ne 1
then
	echo "usage: $0 configuration-file"
fi

. $1

out="$(sh -c "$(ec2-describe-instances | awk '
/^INSTANCE/ {
	# Save dynamic hostname generated by EC2.
	if ($6 == "running")
		hostname[$2] = $4;
}

/^TAG/ {
	if ($2 == "instance" && hostname[$3] != "" && $4 == "hostname") {
		printf "host %s.'$EC2_PDNS_DOMAIN' | grep -q %s;", $5, hostname[$3];
	}
}
')")"

if test ! -z "$out"; then
	echo "The following hostname(s) have wrong CNAME entries in $EC2_PDNS_DOMAIN:"
	echo "$out" | awk '/is an alias/ {print $1}'
fi
